heat_template_version: 2018-08-31

description: Template to deploy all virtual machines of the final scenario

resources:
  # Network resources definition
  net1:
    type: OS::Neutron::Net
    properties:
      name: net1
  subnet1:
    type: OS::Neutron::Subnet
    properties:
     name: subnet1
     network_id: {get_resource: net1}
     allocation_pools: [{"start": 10.1.1.2, "end": 10.1.1.20}]
     gateway_ip: 10.1.1.1
     cidr: 10.1.1.0/24
  net2:
    type: OS::Neutron::Net
    properties:
      name: net2
  subnet2:
    type: OS::Neutron::Subnet
    properties:
     name: subnet2
     network_id: {get_resource: net2}
     allocation_pools: [{"start": 10.1.2.2, "end": 10.1.2.20}]
     gateway_ip: 10.1.2.1
     cidr: 10.1.2.0/24
  router:
    type: OS::Neutron::Router
    properties:
      name: "Firewall"
      external_gateway_info: {network: ExtNet}
  router_if1:
    type: OS::Neutron::RouterInterface
    properties:
      router_id: { get_resource: router }
      subnet_id: { get_resource: subnet1}
  # Web App Servers definition
  s1:
    type: OS::Nova::Server
    properties:
      name: s1
      image: xenial-server-cloudimg-amd64-vnx
      flavor: m1.smaller
      networks:
       - network: {get_resource: net1}
       - network: {get_resource: net2}
  s2:
    type: OS::Nova::Server
    properties:
      name: s2
      image: xenial-server-cloudimg-amd64-vnx
      flavor: m1.smaller
      networks:
       - network: {get_resource: net1}
       - network: {get_resource: net2}
  s3:
    type: OS::Nova::Server
    properties:
      name: s3
      image: xenial-server-cloudimg-amd64-vnx
      flavor: m1.smaller
      networks:
       - network: {get_resource: net1}
       - network: {get_resource: net2}
  # MongoDB Server
  bbdd:
    type: OS::Nova::Server
    properties:
      name: bbdd
      image: mongoVM
      flavor: m1.smaller
      user_data_format: RAW
      user_data: |
        #cloud-config
        runcmd:
          - service mongod start
      networks:
       - network: net2
  # Admin Server definition
  admin:
    type: OS::Nova::Server
    properties:
      name: admin
      image: xenial-server-cloudimg-amd64-vnx
      flavor: m1.smaller
      networks:
       - network: {get_resource: net1}
       - network: {get_resource: net2}
  # Firewall, rules and policies
  fw:
    type: OS::Neutron::Firewall
    properties:
      description: Firewall para filtrar el trafico exterior
      firewall_policy_id: {get_resource: fw_policies}
      name: Firewall
      value_specs: {...}
  fw_policies:
    type: OS::Neutron::FirewallPolicy
    properties:
      audited: Boolean
      description: String
      firewall_rules: [Value, Value, ...]
      name: String
      shared: Boolean
  fw_rules:
    type: OS::Neutron::FirewallRule
    properties:
      action: String
      description: String
      destination_ip_address: String
      destination_port: String
      enabled: Boolean
      ip_version: String
      name: String
      protocol: String
      shared: Boolean
      source_ip_address: String
      source_port: String
